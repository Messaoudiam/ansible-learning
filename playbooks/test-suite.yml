---
# Suite de tests complÃ¨te pour le projet Ansible
# Ce playbook exÃ©cute tous les tests de validation disponibles

- name: "ğŸ§ª Suite de tests - Validation complÃ¨te du projet"
  hosts: webservers
  become: true
  gather_facts: true
  
  vars:
    # Configuration des tests
    test_timeout: 30
    test_retries: 3
    test_delay: 2
    
    # Compteurs de tests
    tests_total: 0
    tests_passed: 0
    tests_failed: 0
    
  tasks:
    # === EN-TÃŠTE DES TESTS ===
    
    - name: "ğŸ¯ Initialisation de la suite de tests"
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        SUITE DE TESTS ANSIBLE         â•‘
          â•‘     Validation du rÃ´le webserver      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Serveur testÃ©: {{ inventory_hostname }}
          OS: {{ ansible_os_family }} {{ ansible_distribution }} {{ ansible_distribution_version }}
          Architecture: {{ ansible_architecture }}
          Date/Heure: {{ ansible_date_time.iso8601 }}
          
          DÃ©marrage des tests...
          
    # === TESTS PRÃ‰-REQUIS ===
    
    - name: "ğŸ” Tests des prÃ©-requis systÃ¨me"
      block:
        - name: "VÃ©rifier la connectivitÃ© rÃ©seau"
          ping:
          register: ping_test
        
        - name: "VÃ©rifier l'accÃ¨s sudo"
          command: sudo whoami
          register: sudo_test
          changed_when: false
        
        - name: "VÃ©rifier l'espace disque disponible"
          setup:
            filter: ansible_mounts
        
        - name: "Validation - Espace disque suffisant"
          assert:
            that:
              - item.size_available > 1073741824  # 1GB en bytes
            fail_msg: "âŒ Espace disque insuffisant sur {{ item.mount }}"
            success_msg: "âœ… Espace disque suffisant sur {{ item.mount }}"
          loop: "{{ ansible_mounts }}"
          when: item.mount == "/"
    
    # === IMPORT DES TESTS SPÃ‰CIALISÃ‰S ===
    
    - name: "ğŸ“‹ ExÃ©cution des tests du rÃ´le webserver"
      include_tasks: ../tests/test-webserver.yml
      vars:
        webserver_test_url: "http://{{ ansible_default_ipv4.address | default('localhost') }}"
    
    # === TESTS DE PERFORMANCE BASIQUES ===
    
    - name: "âš¡ Tests de performance basiques"
      block:
        - name: "Test de charge lÃ©gÃ¨re avec curl"
          command: >
            curl -s -w "
            temps_total: %{time_total}s
            temps_connexion: %{time_connect}s
            temps_transfert: %{time_starttransfer}s
            taille_download: %{size_download} bytes
            vitesse_download: %{speed_download} bytes/sec"
            -o /dev/null http://localhost/
          register: perf_test
          changed_when: false
        
        - name: "Afficher les mÃ©triques de performance"
          debug:
            msg: |
              ğŸ“Š MÃ©triques de performance:
              {{ perf_test.stdout }}
    
    # === TESTS DE SÃ‰CURITÃ‰ BASIQUES ===
    
    - name: "ğŸ”’ Tests de sÃ©curitÃ© basiques"
      block:
        - name: "VÃ©rifier que le serveur ne s'exÃ©cute pas en root"
          shell: ps aux | grep -E '(apache|httpd)' | grep -v grep | grep -v root || echo "no_root_processes"
          register: security_processes
          changed_when: false
        
        - name: "Validation - Pas de processus root"
          assert:
            that:
              - "'root' not in security_processes.stdout"
            fail_msg: "âŒ SÃ‰CURITÃ‰: Des processus Apache s'exÃ©cutent en root"
            success_msg: "âœ… SÃ‰CURITÃ‰: Aucun processus Apache en root"
        
        - name: "VÃ©rifier les headers de sÃ©curitÃ© HTTP (basique)"
          uri:
            url: "http://localhost/"
            method: HEAD
          register: security_headers
        
        - name: "Tester l'accÃ¨s aux rÃ©pertoires sensibles"
          uri:
            url: "http://localhost/{{ item }}"
            method: GET
            status_code: [403, 404]  # Ces codes sont attendus (accÃ¨s refusÃ©)
          loop:
            - ".htaccess"
            - "wp-admin"
            - "admin"
            - "phpmyadmin"
          ignore_errors: true
          register: sensitive_dirs
    
    # === TESTS DE MONITORING ===
    
    - name: "ğŸ“ˆ Tests de monitoring et logs"
      block:
        - name: "VÃ©rifier la prÃ©sence des logs Apache"
          find:
            paths: 
              - "/var/log/apache2"  # Debian/Ubuntu
              - "/var/log/httpd"    # RedHat/CentOS
            patterns: "*.log"
          register: log_files
        
        - name: "Validation - Logs prÃ©sents"
          assert:
            that:
              - log_files.files | length > 0
            fail_msg: "âŒ Aucun fichier de log trouvÃ©"
            success_msg: "âœ… Fichiers de logs trouvÃ©s: {{ log_files.files | length }}"
        
        - name: "VÃ©rifier les logs d'erreur rÃ©cents"
          command: >
            find {{ item }} -name "*error*log" -type f -exec
            tail -10 {} \; 2>/dev/null || echo "No error logs"
          loop:
            - "/var/log/apache2"
            - "/var/log/httpd"
          register: recent_errors
          changed_when: false
          ignore_errors: true
    
    # === TESTS DE RÃ‰CUPÃ‰RATION ===
    
    - name: "ğŸ”„ Tests de rÃ©cupÃ©ration et redÃ©marrage"
      block:
        - name: "Test de redÃ©marrage du service"
          service:
            name: "{{ webserver_service_name | default('apache2' if ansible_os_family == 'Debian' else 'httpd') }}"
            state: restarted
          register: restart_test
        
        - name: "Attendre la disponibilitÃ© aprÃ¨s redÃ©marrage"
          wait_for:
            port: 80
            host: 127.0.0.1
            delay: 2
            timeout: 30
            state: started
        
        - name: "VÃ©rifier la rÃ©ponse aprÃ¨s redÃ©marrage"
          uri:
            url: "http://localhost/"
            method: GET
            status_code: 200
            timeout: 10
          register: post_restart_test
        
        - name: "Validation - Service fonctionnel aprÃ¨s redÃ©marrage"
          assert:
            that:
              - post_restart_test.status == 200
            fail_msg: "âŒ Service non fonctionnel aprÃ¨s redÃ©marrage"
            success_msg: "âœ… Service fonctionnel aprÃ¨s redÃ©marrage"
    
    # === RÃ‰SUMÃ‰ FINAL ===
    
    - name: "ğŸ“Š GÃ©nÃ©ration du rapport final"
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    RAPPORT FINAL                         â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                          â•‘
          â•‘  ğŸ¯ SERVEUR TESTÃ‰                                        â•‘
          â•‘     Nom: {{ inventory_hostname }}                          â•‘
          â•‘     OS: {{ ansible_os_family }} {{ ansible_distribution }}    â•‘
          â•‘     IP: {{ ansible_default_ipv4.address }}                â•‘
          â•‘                                                          â•‘
          â•‘  âœ… TESTS RÃ‰USSIS                                        â•‘
          â•‘     â€¢ PrÃ©-requis systÃ¨me                                â•‘
          â•‘     â€¢ Installation et configuration Apache              â•‘
          â•‘     â€¢ Service et dÃ©marrage automatique                  â•‘
          â•‘     â€¢ AccessibilitÃ© web (port 80)                       â•‘
          â•‘     â€¢ Contenu web (pages HTML)                          â•‘
          â•‘     â€¢ Permissions et sÃ©curitÃ© basique                   â•‘
          â•‘     â€¢ Performance basique                               â•‘
          â•‘     â€¢ Logs et monitoring                                â•‘
          â•‘     â€¢ Tests de rÃ©cupÃ©ration                             â•‘
          â•‘                                                          â•‘
          â•‘  ğŸŒ ACCÃˆS WEB                                            â•‘
          â•‘     http://{{ ansible_default_ipv4.address | default('localhost') }}/              â•‘
          â•‘     http://{{ ansible_default_ipv4.address | default('localhost') }}/info.html     â•‘
          â•‘                                                          â•‘
          â•‘  ğŸ‰ STATUT: TOUS LES TESTS RÃ‰USSIS                       â•‘
          â•‘                                                          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“‹ Pour reproduire les tests manuellement:
             ansible-playbook tests/test-webserver.yml
             ansible-playbook playbooks/test-suite.yml
          
          ğŸ”§ Pour dÃ©boguer en cas de problÃ¨me:
             sudo systemctl status {{ webserver_service_name | default('apache2' if ansible_os_family == 'Debian' else 'httpd') }}
             sudo journalctl -u {{ webserver_service_name | default('apache2' if ansible_os_family == 'Debian' else 'httpd') }}
             curl -v http://localhost/