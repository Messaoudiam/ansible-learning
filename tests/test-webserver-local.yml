---
# Tests pour la configuration locale (sans sudo)
# Alternative simple pour tester sans Apache complet

- name: "Tests de validation - Configuration locale"
  hosts: localhost
  gather_facts: true
  
  vars:
    web_directory: "{{ playbook_dir | dirname }}/playbooks/web"
    test_port: 8080
    
  tasks:
    # === PRÃ‰PARATION DES TESTS ===
    
    - name: "ğŸ§ª DÃ©but des tests de la configuration locale"
      debug:
        msg: |
          === TESTS CONFIGURATION LOCALE ===
          RÃ©pertoire web: {{ web_directory }}
          Port de test: {{ test_port }}
          Serveur: {{ inventory_hostname }}
          ===================================
    
    # === TEST 1: FICHIERS WEB ===
    
    - name: "Test 1: VÃ©rifier l'existence du rÃ©pertoire web"
      stat:
        path: "{{ web_directory }}"
      register: web_dir_test
    
    - name: "Test 1: Validation - RÃ©pertoire web"
      assert:
        that:
          - web_dir_test.stat.exists
          - web_dir_test.stat.isdir
        fail_msg: "âŒ Ã‰CHEC: Le rÃ©pertoire web n'existe pas"
        success_msg: "âœ… SUCCÃˆS: Le rÃ©pertoire web existe"
    
    - name: "Test 2: VÃ©rifier le fichier index.html"
      stat:
        path: "{{ web_directory }}/index.html"
      register: index_test
    
    - name: "Test 2: Validation - Fichier index.html"
      assert:
        that:
          - index_test.stat.exists
          - index_test.stat.isreg
        fail_msg: "âŒ Ã‰CHEC: Le fichier index.html n'existe pas"
        success_msg: "âœ… SUCCÃˆS: Le fichier index.html existe"
    
    # === TEST 3: CONTENU HTML ===
    
    - name: "Test 3: VÃ©rifier le contenu HTML"
      slurp:
        src: "{{ web_directory }}/index.html"
      register: html_content
    
    - name: "Test 3: Validation - Contenu HTML"
      assert:
        that:
          - "'<!DOCTYPE html>' in (html_content.content | b64decode)"
          - "'<html' in (html_content.content | b64decode)"
          - "('Ansible' in (html_content.content | b64decode)) or ('Test Local' in (html_content.content | b64decode))"
        fail_msg: "âŒ Ã‰CHEC: Le contenu HTML n'est pas valide"
        success_msg: "âœ… SUCCÃˆS: Le contenu HTML est valide"
    
    # === TEST 4: PYTHON DISPONIBLE ===
    
    - name: "Test 4: VÃ©rifier que Python3 est disponible"
      command: python3 --version
      register: python_test
      changed_when: false
    
    - name: "Test 4: Validation - Python3"
      assert:
        that:
          - python_test.rc == 0
          - "'Python 3' in python_test.stdout"
        fail_msg: "âŒ Ã‰CHEC: Python3 n'est pas disponible"
        success_msg: "âœ… SUCCÃˆS: Python3 est disponible ({{ python_test.stdout.strip() }})"
    
    # === TEST 5: SERVEUR WEB DE TEST ===
    
    - name: "Test 5: DÃ©marrer le serveur web temporaire"
      shell: |
        cd {{ web_directory }}
        python3 -m http.server {{ test_port }} &
        echo $! > server.pid
        sleep 3
      register: server_start
      changed_when: false
    
    - name: "Test 5: VÃ©rifier que le port est en Ã©coute"
      wait_for:
        port: "{{ test_port }}"
        host: 127.0.0.1
        delay: 1
        timeout: 10
        state: started
      register: port_test
    
    - name: "Test 5: Validation - Port en Ã©coute"
      assert:
        that:
          - port_test is succeeded
        fail_msg: "âŒ Ã‰CHEC: Le port {{ test_port }} n'est pas en Ã©coute"
        success_msg: "âœ… SUCCÃˆS: Le port {{ test_port }} est en Ã©coute"
    
    # === TEST 6: RÃ‰PONSE HTTP ===
    
    - name: "Test 6: Tester la rÃ©ponse HTTP"
      uri:
        url: "http://127.0.0.1:{{ test_port }}/"
        method: GET
        status_code: 200
        timeout: 10
      register: http_test
      ignore_errors: true
    
    - name: "Test 6: Validation - RÃ©ponse HTTP"
      assert:
        that:
          - http_test.status == 200
        fail_msg: "âŒ Ã‰CHEC: Le serveur ne rÃ©pond pas correctement"
        success_msg: "âœ… SUCCÃˆS: Le serveur rÃ©pond avec le code 200"
      when: http_test is defined
    
    # === TEST 7: CONTENU WEB ACCESSIBLE ===
    
    - name: "Test 7: VÃ©rifier le contenu web accessible"
      uri:
        url: "http://127.0.0.1:{{ test_port }}/"
        method: GET
        return_content: true
      register: content_test
      when: http_test.status == 200
    
    - name: "Test 7: Validation - Contenu accessible"
      assert:
        that:
          - "'html' in content_test.content"
          - "('Ansible' in content_test.content) or ('Test' in content_test.content)"
        fail_msg: "âŒ Ã‰CHEC: Le contenu web n'est pas correct"
        success_msg: "âœ… SUCCÃˆS: Le contenu web est accessible et correct"
      when: content_test is defined and content_test.content is defined
    
    # === NETTOYAGE ===
    
    - name: "ArrÃªter le serveur web temporaire"
      shell: |
        cd {{ web_directory }}
        if [ -f server.pid ]; then
          kill $(cat server.pid) 2>/dev/null || true
          rm -f server.pid
        fi
        # Alternative: tuer tous les serveurs Python sur ce port
        lsof -ti:{{ test_port }} | xargs kill -9 2>/dev/null || true
      register: cleanup
      changed_when: false
      ignore_errors: true
    
    # === RÃ‰SUMÃ‰ DES TESTS ===
    
    - name: "ğŸ“Š RÃ©sumÃ© des tests locaux"
      debug:
        msg: |
          
          =========================================
          ğŸ“Š RÃ‰SUMÃ‰ DES TESTS - CONFIGURATION LOCALE
          =========================================
          
          âœ… Test 1: RÃ©pertoire web prÃ©sent
          âœ… Test 2: Fichier index.html crÃ©Ã©
          âœ… Test 3: Contenu HTML valide
          âœ… Test 4: Python3 disponible
          âœ… Test 5: Port {{ test_port }} accessible
          âœ… Test 6: RÃ©ponse HTTP 200
          âœ… Test 7: Contenu web accessible
          
          ğŸ‰ TOUS LES TESTS LOCAUX ONT RÃ‰USSI !
          
          Pour dÃ©marrer manuellement le serveur:
          cd {{ web_directory }}
          python3 -m http.server {{ test_port }}
          
          Puis visitez: http://localhost:{{ test_port }}
          
          =========================================