# Dockerfile template pour les tests Molecule
# Ce fichier configure les conteneurs de test avec systemd

{% if item.image.startswith('ubuntu') %}
FROM {{ item.image }}

ENV DEBIAN_FRONTEND=noninteractive

# Installation des packages de base pour les tests
RUN apt-get update && \
    apt-get install -y \
        python3 \
        python3-pip \
        sudo \
        systemd \
        systemctl \
        curl \
        ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Configuration systemd
RUN systemctl set-default multi-user.target
RUN systemctl mask \
    dev-hugepages.mount \
    sys-fs-fuse-connections.mount \
    sys-kernel-config.mount \
    display-manager.service \
    graphical.target \
    systemd-logind.service

{% elif item.image.startswith('quay.io/centos') or item.image.startswith('centos') %}
FROM {{ item.image }}

# Installation des packages de base pour les tests
RUN dnf update -y && \
    dnf install -y \
        python3 \
        python3-pip \
        sudo \
        systemd \
        curl \
        ca-certificates \
    && dnf clean all

# Configuration systemd
RUN systemctl set-default multi-user.target
RUN systemctl mask \
    dev-hugepages.mount \
    sys-fs-fuse-connections.mount \
    sys-kernel-config.mount \
    display-manager.service \
    graphical.target \
    systemd-logind.service

{% endif %}

# CrÃ©er un utilisateur pour les tests
RUN useradd -m -s /bin/bash molecule && \
    echo 'molecule ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

VOLUME ["/sys/fs/cgroup"]
CMD ["/sbin/init"]